<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Control Panel</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Loading screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loading-warning" class="loading-warning" style="display: none;">长时间加载？请尝试重启软件</div>
        </div>
    </div>

    <!-- Background elements -->
    <div class="background-elements">
        <div class="floating-circle circle-1"></div>
        <div class="floating-circle circle-2"></div>
        <div class="floating-circle circle-3"></div>
    </div>

    <div class="container">


        <!-- Status bar -->
        <div class="status-bar">
            <div class="quote-item">
                <span id="quote-text">加载中...</span>
            </div>
            <div class="status-item llm-status">
                <span>LLM 状态: </span>
                <span id="llm-status" class="checking">检查中...</span>
            </div>
        </div>

        <!-- Main content grid -->
        <div class="content-grid">
            <!-- Left column -->
            <div class="left-column">
                <!-- Logs section -->
                <div class="card logs-section">
                    <div class="logs-header">
                        <h2>系统日志</h2>
                        <button class="btn btn-danger" onclick="clearLogs()">清空日志</button>
                    </div>
                    <div class="logs-container" id="logs-container">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Stats section -->
                <div class="card">
                    <h2>统计信息</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-value" id="total-messages">0</span>
                            <span class="stat-label">总消息数</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="proactive-chats">0</span>
                            <span class="stat-label">主动聊天</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value" id="reminders">0</span>
                            <span class="stat-label">提醒次数</span>
                        </div>
                    </div>
                </div>

                <!-- Scheduled events -->
                <div class="card">
                    <h2>计划事件</h2>
                    <div class="events-list" id="events-list">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right column -->
            <div class="right-column">
                <!-- Settings tabs -->
                <div class="card">
                    <h2>配置管理</h2>
                    <div class="tabs">
                        <button class="tab-button active" onclick="switchTab('general-settings', event)">通用设置</button>
                        <button class="tab-button" onclick="switchTab('llm-settings', event)">LLM 设置</button>
                        <button class="tab-button" onclick="switchTab('prompt-settings', event)">提示词设置</button>
                    </div>
                    <div class="tab-content">
                        <!-- General settings -->
                        <div id="general-settings" class="tab-pane">
                            <div class="form-group">
                                <label for="websocket-server-uri">
                                    WebSocket 服务器地址
                                    <div class="help-tooltip">
                                        <div class="help-icon">?</div>
                                        <div class="tooltip-text">
                                            连接到消息服务器的地址，用于接收用户消息和发送AI回复。必须使用遵守OneBot协议的框架，通常设置为本地服务器地址，如ws://localhost:3000。
                                        </div>
                                    </div>
                                </label>
                                <input type="text" id="websocket-server-uri" placeholder="ws://localhost:3000">
                            </div>
                            <div class="form-group">
                                <label for="websocket-keep-alive">WebSocket 心跳间隔 (ms)</label>
                                <input type="number" id="websocket-keep-alive" min="5000" max="60000">
                            </div>
                            <div class="form-group">
                                <label for="max-context-rounds">
                                    最大上下文轮数
                                    <div class="help-tooltip">
                                        <div class="help-icon">?</div>
                                        <div class="tooltip-text">
                                            控制对话历史的长度。当上下文消息数超过设定值的2倍时，会触发上下文总结，将旧的对话历史压缩成一个总结，只保留核心信息。值越大，AI可以记住的对话越多，但会增加API调用成本和响应时间。
                                        </div>
                                    </div>
                                </label>
                                <input type="number" id="max-context-rounds" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label for="target-user-id">目标用户 ID</label>
                                <input type="number" id="target-user-id">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="active-chat-probability">主动聊天概率 (%)</label>
                                    <input type="number" id="active-chat-probability" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label for="min-safe-delay">最小安全延迟 (ms)</label>
                                    <input type="number" id="min-safe-delay" min="500" max="10000">
                                </div>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="proactive-chat-enabled">
                                <label for="proactive-chat-enabled">启用主动聊天</label>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="reminder-enabled">
                                <label for="reminder-enabled">启用提醒功能</label>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="reinforcement-enabled">
                                <label for="reinforcement-enabled">
                                    启用动态提示词注入(测试)
                                    <div class="help-tooltip">
                                        <div class="help-icon">?</div>
                                        <div class="tooltip-text">
                                            测试功能：在每3条用户消息后自动注入身份强化提示词，确保AI保持设定的角色身份和行为一致性。
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-checkbox">
                                <input type="checkbox" id="intent-analysis-enabled">
                                <label for="intent-analysis-enabled">
                                    启用前置语义判断
                                    <div class="help-tooltip">
                                        <div class="help-icon">?</div>
                                        <div class="tooltip-text">
                                            验证用户消息的完整性：分析用户输入是否完整，对于不完整的消息会缓冲等待进一步输入，对于不确定的消息会进入观察窗口。
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- LLM settings -->
                        <div id="llm-settings" class="tab-pane" style="display: none;">
                            <div class="form-group">
                                <label for="llm-model-name">LLM 模型名称</label>
                                <input type="text" id="llm-model-name" placeholder="qwen-plus">
                            </div>
                            <div class="form-group">
                                <label for="llm-api-base-url">LLM API 基础 URL</label>
                                <input type="text" id="llm-api-base-url" placeholder="https://api.example.com/v1/chat/completions">
                            </div>
                            <div class="form-group">
                                <label for="llm-api-key">LLM API Key</label>
                                <input type="password" id="llm-api-key" placeholder="sk-...">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="llm-max-tokens">
                                        最大 Tokens
                                        <div class="help-tooltip">
                                            <div class="help-icon">?</div>
                                            <div class="tooltip-text">
                                                控制AI响应的最大长度。值越大，AI可以生成更长的回答，但会增加API调用成本和响应时间。
                                            </div>
                                        </div>
                                    </label>
                                    <input type="number" id="llm-max-tokens" min="100" max="4096">
                                </div>
                                <div class="form-group">
                                    <label for="llm-temperature">
                                        Temperature
                                        <div class="help-tooltip">
                                            <div class="help-icon">?</div>
                                            <div class="tooltip-text">
                                                控制AI响应的随机性。值越高，回答越随机；值越低，回答越确定和保守。建议范围：0.7-1.0。
                                            </div>
                                        </div>
                                    </label>
                                    <input type="number" id="llm-temperature" min="0" max="2" step="0.1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="llm-top-p">
                                    Top P
                                    <div class="help-tooltip">
                                        <div class="help-icon">?</div>
                                        <div class="tooltip-text">
                                            控制AI选择词汇的范围。值越低，AI选择的词汇越集中；值越高，选择范围越广。与Temperature配合使用。
                                        </div>
                                    </div>
                                </label>
                                <div style="display: flex; gap: 10px; align-items: flex-end;">
                                    <input type="number" id="llm-top-p" min="0" max="1" step="0.05" style="flex: 1;">
                                    <button class="btn btn-primary" onclick="checkLlmStatus()">测试是否可用</button>
                                </div>
                            </div>
                        </div>

                        <!-- Prompt settings -->
                        <div id="prompt-settings" class="tab-pane" style="display: none;">
                            <div class="form-group">
                                <label for="base-system-prompt">
                                    基础系统提示词
                                    <div class="help-tooltip bottom">
                                        <div class="help-icon">?</div>
                                        <div class="tooltip-text">
                                            定义AI的角色、行为准则、互动规范等核心设定，是AI回复的基础框架。包含角色设定、日常行程、核心互动准则等详细内容。
                                        </div>
                                    </div>
                                </label>
                                <textarea id="base-system-prompt" class="prompt-editor" placeholder="在此输入基础系统提示词..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="incomplete-input-prompt">
                                    语义判断提示词
                                    <div class="help-tooltip">
                                        <div class="help-icon">?</div>
                                        <div class="tooltip-text">
                                            用于判断用户消息是否完整的提示词。当启用前置语义判断时，系统会使用此提示词分析用户输入是否完整，分为完整、不确定和不完整三个级别。
                                        </div>
                                    </div>
                                </label>
                                <textarea id="incomplete-input-prompt" class="prompt-editor" placeholder="在此输入前置语义判断提示词..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="reinforcement-prompt">
                                    动态提示词注入
                                    <div class="help-tooltip">
                                        <div class="help-icon">?</div>
                                        <div class="tooltip-text">
                                            用于在特定里程碑时注入的身份强化提示词。当启用动态提示词注入时，系统会每3条用户消息后注入此提示词，确保AI保持设定的角色身份。
                                        </div>
                                    </div>
                                </label>
                                <textarea id="reinforcement-prompt" class="prompt-editor" placeholder="在此输入动态提示词注入..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="settings-footer">
                        <button class="btn btn-primary" onclick="saveConfig()">保存配置</button>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- QQ Group Modal -->
    <div id="qq-group-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📱 加入 QQ 交流群</h2>
                <button class="close-button" onclick="closeQqGroupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>欢迎加入我们的 QQ 交流群，一起讨论和分享 AI 相关的知识！</p>
                <div class="qq-group-info">
                    <div class="group-code">
                        <span class="code-label">群号：</span>
                        <span class="code-value">1071354740</span>
                    </div>
                    <div class="group-qrcode">
                        <img src="css/QQ.png" alt="QQ Group QR Code">
                    </div>
                </div>
                <div class="commercial-warning">
                    <p>⚠️ 重要提示：本项目遵循 GPLv3 开源协议！</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQqGroupModal()">稍后再说</button>
                <a href="http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=1pOX2q6gKl41GttJcuXDoCuBVlEhWNTS&authKey=PI7D%2FlEFqlD%2B6zLjE7FCTbzsVBig%2BWMy5rCHAlQOIpsRsUZKCA%2FOYzBDzzUA%2FAaf&noverify=0&group_code=1071354740" target="_blank" class="btn btn-primary">
                    立即加入
                </a>
            </div>
        </div>
    </div>

    <script src="js/script.js"></script>
</body>
</html>