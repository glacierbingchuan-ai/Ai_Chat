<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Control Panel</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Loading screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loading-warning" class="loading-warning" style="display: none;">长时间加载？请尝试重启软件</div>
        </div>
    </div>

    <!-- Background elements -->
    <div class="background-elements">
        <div class="floating-circle circle-1"></div>
        <div class="floating-circle circle-2"></div>
        <div class="floating-circle circle-3"></div>
    </div>

    <!-- Snow animation -->
    <div class="snow-container" id="snow-container"></div>

    <div class="container with-sidebar">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Ai_Chat</h2>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" onclick="switchView('dashboard')">
                    <span class="menu-icon">📊</span>
                    <span class="menu-text">控制面板</span>
                </div>
                <div class="menu-item" onclick="switchView('role-cards')">
                    <span class="menu-icon">🎭</span>
                    <span class="menu-text">角色卡广场</span>
                </div>
                <div class="menu-item" onclick="switchView('chat-history')">
                    <span class="menu-icon">💬</span>
                    <span class="menu-text">聊天记录</span>
                </div>
                <div class="menu-item" onclick="switchView('about')">
                    <span class="menu-icon">ℹ️</span>
                    <span class="menu-text">关于</span>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="menu-item" onclick="showQqGroupModal()">
                    <span class="menu-icon">💬</span>
                    <span class="menu-text">加入交流群</span>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Status bar -->
            <div class="status-bar">
                <div class="quote-item">
                    <span id="quote-text">加载中...</span>
                </div>
                <div class="status-item llm-status">
                    <span>LLM 状态: </span>
                    <span id="llm-status" class="checking">检查中...</span>
                </div>
            </div>

            <!-- Dashboard view -->
            <div id="dashboard-view" class="view-content">
                <!-- Main content grid -->
                <div class="content-grid">
                    <!-- Left column -->
                    <div class="left-column">
                        <!-- System Logs -->
                        <div class="card logs-section">
                            <div class="logs-header">
                                <h2>系统日志</h2>
                                <button class="btn btn-danger" onclick="clearLogs()">清空日志</button>
                            </div>
                            <div class="logs-container" id="logs-container">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats and Events section -->
                        <div class="stats-events-container">
                            <!-- Stats section -->
                            <div class="card stats-card">
                                <h2>统计信息</h2>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <span class="stat-value" id="total-messages">0</span>
                                        <span class="stat-label">总消息数</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-value" id="proactive-chats">0</span>
                                        <span class="stat-label">主动聊天</span>
                                    </div>
                                    <div class="stat-card">
                                        <span class="stat-value" id="reminders">0</span>
                                        <span class="stat-label">提醒次数</span>
                                    </div>
                                </div>
                                <div class="stats-footer">
                                    <div class="clear-context-section">
                                        <button class="btn btn-warning" onclick="clearContext()">清空上下文</button>
                                        <div class="clear-context-info">
                                            <span class="info-text">清空对话历史，重置AI对话状态</span>
                                            <span class="info-note">修改提示词后需清空上下文才可生效</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Scheduled events -->
                            <div class="card events-card">
                                <h2>计划事件</h2>
                                <div class="events-list" id="events-list">
                                    <div class="loading">
                                        <div class="loading-spinner"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right column -->
                    <div class="right-column">
                        <!-- Settings tabs -->
                        <div class="card settings-card">
                            <h2>配置管理</h2>
                            <div class="tabs">
                                <button class="tab-button active" onclick="switchTab('general-settings', event)">通用设置</button>
                                <button class="tab-button" onclick="switchTab('llm-settings', event)">LLM 设置</button>
                                <button class="tab-button" onclick="switchTab('prompt-settings', event)">提示词设置</button>
                            </div>
                            <div class="tab-content">
                                <!-- General settings -->
                                <div id="general-settings" class="tab-pane">
                                    <div class="form-group">
                                        <label for="websocket-server-uri">
                                            WebSocket 协议端地址
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    连接到消息协议端的地址，用于接收用户消息和发送AI回复。必须使用遵守OneBot协议的框架，通常设置为本地服务器地址，如ws://localhost:3000。
                                                </div>
                                            </div>
                                        </label>
                                        <input type="text" id="websocket-server-uri" placeholder="ws://localhost:3000">
                                    </div>
                                    <div class="form-group">
                                        <label for="websocket-token">
                                            WebSocket 认证 Token
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    可空：用于WebSocket连接认证的token，当服务器要求认证时使用。将以Bearer方式添加到WebSocket连接头中。
                                                </div>
                                            </div>
                                        </label>
                                        <input type="password" id="websocket-token" placeholder="可空：如果有，请输入认证token">
                                    </div>
                                    <div class="form-group">
                                        <label for="websocket-keep-alive">WebSocket 心跳间隔 (ms)</label>
                                        <input type="number" id="websocket-keep-alive" min="5000" max="60000">
                                    </div>
                                    <div class="form-group">
                                        <label for="max-context-rounds">
                                            最大上下文轮数
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    控制对话历史的长度。当上下文消息数超过设定值的2倍时，会触发上下文总结，将旧的对话历史压缩成一个总结，只保留核心信息。值越大，AI可以记住的对话越多，但会增加API调用成本和响应时间。
                                                </div>
                                            </div>
                                        </label>
                                        <input type="number" id="max-context-rounds" min="1" max="50">
                                    </div>
                                    <div class="form-group">
                                        <label for="target-user-id">目标用户 ID</label>
                                        <input type="number" id="target-user-id">
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="active-chat-probability">主动聊天概率 (%)</label>
                                            <input type="number" id="active-chat-probability" min="0" max="100">
                                        </div>
                                        <div class="form-group">
                                            <label for="min-safe-delay">最小安全延迟 (ms)</label>
                                            <input type="number" id="min-safe-delay" min="500" max="10000">
                                        </div>
                                    </div>
                                    <div class="form-checkbox">
                                        <input type="checkbox" id="proactive-chat-enabled">
                                        <label for="proactive-chat-enabled">
                                            启用主动聊天
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    允许AI在空闲时段主动发起聊天，夜间11点到次日早上6点不会触发主动聊天。
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="form-checkbox">
                                        <input type="checkbox" id="reminder-enabled">
                                        <label for="reminder-enabled">启用提醒功能</label>
                                    </div>
                                    <div class="form-checkbox">
                                        <input type="checkbox" id="reinforcement-enabled">
                                        <label for="reinforcement-enabled">
                                            启用动态提示词注入(测试)
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    测试功能：在每3条用户消息后自动注入身份强化提示词，确保AI保持设定的角色身份和行为一致性。
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="form-checkbox">
                                        <input type="checkbox" id="intent-analysis-enabled">
                                        <label for="intent-analysis-enabled">
                                            启用前置语义判断
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    验证用户消息的完整性：分析用户输入是否完整，对于不完整的消息会缓冲等待进一步输入，对于不确定的消息会进入观察窗口。
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- LLM settings -->
                                <div id="llm-settings" class="tab-pane" style="display: none;">
                                    <div class="form-group">
                                        <label for="llm-model-name">LLM 模型名称</label>
                                        <input type="text" id="llm-model-name" placeholder="qwen-plus">
                                    </div>
                                    <div class="form-group">
                                        <label for="llm-api-base-url">LLM API 基础 URL</label>
                                        <input type="text" id="llm-api-base-url" placeholder="https://api.example.com/v1/chat/completions">
                                    </div>
                                    <div class="form-group">
                                        <label for="llm-api-key">LLM API Key</label>
                                        <input type="password" id="llm-api-key" placeholder="sk-...">
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="llm-max-tokens">
                                                最大 Tokens
                                                <div class="help-tooltip">
                                                    <div class="help-icon">?</div>
                                                    <div class="tooltip-text">
                                                        控制AI响应的最大长度。值越大，AI可以生成更长的回答，但会增加API调用成本和响应时间。
                                                    </div>
                                                </div>
                                            </label>
                                            <input type="number" id="llm-max-tokens" min="100" max="4096">
                                        </div>
                                        <div class="form-group">
                                            <label for="llm-temperature">
                                                Temperature
                                                <div class="help-tooltip">
                                                    <div class="help-icon">?</div>
                                                    <div class="tooltip-text">
                                                        控制AI响应的随机性。值越高，回答越随机；值越低，回答越确定和保守。建议范围：0.7-1.0。
                                                    </div>
                                                </div>
                                            </label>
                                            <input type="number" id="llm-temperature" min="0" max="2" step="0.1">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="llm-top-p">
                                            Top P
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    控制AI选择词汇的范围。值越低，AI选择的词汇越集中；值越高，选择范围越广。与Temperature配合使用。
                                                </div>
                                            </div>
                                        </label>
                                        <div style="display: flex; gap: 10px; align-items: flex-end;">
                                            <input type="number" id="llm-top-p" min="0" max="1" step="0.05" style="flex: 1;">
                                            <button class="btn btn-primary" onclick="checkLlmStatus()">测试是否可用</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Prompt settings -->
                                <div id="prompt-settings" class="tab-pane" style="display: none;">
                                    <div class="form-group">
                                        <label for="base-system-prompt">
                                            基础系统提示词
                                            <div class="help-tooltip bottom">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    定义AI的角色、行为准则、互动规范等核心设定，是AI回复的基础框架。包含角色设定、日常行程、核心互动准则等详细内容。
                                                </div>
                                            </div>
                                        </label>
                                        <textarea id="base-system-prompt" class="prompt-editor" placeholder="在此输入基础系统提示词..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="incomplete-input-prompt">
                                            语义判断提示词
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    用于判断用户消息是否完整的提示词。当启用前置语义判断时，系统会使用此提示词分析用户输入是否完整，分为完整、不确定和不完整三个级别。
                                                </div>
                                            </div>
                                        </label>
                                        <textarea id="incomplete-input-prompt" class="prompt-editor" placeholder="在此输入前置语义判断提示词..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="reinforcement-prompt">
                                            动态提示词注入
                                            <div class="help-tooltip">
                                                <div class="help-icon">?</div>
                                                <div class="tooltip-text">
                                                    用于在特定里程碑时注入的身份强化提示词。当启用动态提示词注入时，系统会每3条用户消息后注入此提示词，确保AI保持设定的角色身份。
                                                </div>
                                            </div>
                                        </label>
                                        <textarea id="reinforcement-prompt" class="prompt-editor" placeholder="在此输入动态提示词注入..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-footer">
                                <button class="btn btn-primary" onclick="saveConfig()">保存配置</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Role Cards view -->
            <div id="role-cards-view" class="view-content" style="display: none;">
                <div class="card role-cards-page">
                    <h2>角色卡广场</h2>
                    <div class="role-cards-header">
                        <h3>探索角色卡</h3>
                        <div class="header-buttons">
                            <button class="btn btn-primary" onclick="loadRoleCards()">刷新角色卡列表</button>
                            <button class="btn btn-secondary" onclick="showRoleCardsSettingsModal()">⚙️ 设置</button>
                        </div>
                    </div>
                    <div class="role-cards-container" id="role-cards-container">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>加载角色卡中...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat History view -->
            <div id="chat-history-view" class="view-content" style="display: none;">
                <div class="card chat-history-page">
                    <h2>聊天记录</h2>
                    <div class="chat-history-header">
                        <h3>历史消息</h3>
                        <button class="btn btn-primary" onclick="loadChatHistory()">刷新聊天记录</button>
                    </div>
                    <div class="chat-messages-container" id="chat-messages-container">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>加载聊天记录中...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About view -->
            <div id="about-view" class="view-content" style="display: none;">
                <div class="card about-page">
                    <h2>关于 Ai_Chat</h2>
                    
                    <!-- Author Info Section -->
                    <div class="author-info">
                        <div class="author-avatar" onclick="toggleMirrorEffect()">
                            <img src="css/glacier.jpg" alt="冰川">
                        </div>
                        <div class="author-details">
                            <h3>冰川</h3>
                            <p>QQ：3917952948</p>
                        </div>
                    </div>
                    
                    <div class="about-content">
                        <div class="about-section">
                            <h3>项目简介</h3>
                            <p>Ai_Chat 是一个基于大语言模型的智能聊天机器人系统，支持多平台消息协议，提供丰富的角色卡功能和个性化设置。</p>
                        </div>
                        <div class="about-section">
                            <h3>核心功能</h3>
                            <ul>
                                <li>支持多种大语言模型接入</li>
                                <li>角色卡广场，丰富的角色选择</li>
                                <li>智能上下文管理</li>
                                <li>主动聊天和提醒功能</li>
                                <li>实时系统监控和日志</li>
                            </ul>
                        </div>
                        <div class="about-section">
                            <h3>技术栈</h3>
                            <ul>
                                <li>前端：HTML5, CSS3, JavaScript</li>
                                <li>后端：C#</li>
                                <li>通信：WebSocket, REST API</li>
                                <li>协议：OneBot 协议</li>
                            </ul>
                        </div>
                        <div class="about-section">
                            <h3>开源协议</h3>
                            <p>本项目遵循 GPLv3 开源协议，欢迎贡献代码和提出建议。</p>
                            <div class="license-details">
                                <p>GPLv3 (GNU General Public License v3.0) 是一种广泛使用的自由软件许可证，其核心条款包括：</p>
                                <ul>
                                    <li>自由运行：任何人都可以自由运行该软件，用于任何目的</li>
                                    <li>自由学习：任何人都可以自由查看和学习软件的源代码</li>
                                    <li>自由修改：任何人都可以自由修改软件，创建衍生作品</li>
                                    <li>自由分享：任何人都可以自由分享软件的原始版本或修改版本</li>
                                    <li>传染性：基于本软件的衍生作品也必须采用 GPLv3 许可证</li>
                                </ul>
                                <p>选择 GPLv3 许可证意味着我们致力于软件的自由和开放，希望通过社区协作共同改进和发展这个项目。</p>
                            </div>
                        </div>
                        <div class="about-section">
                            <h3>联系我们</h3>
                            <p>QQ 交流群：1071354740</p>
                            <p>欢迎加入我们的社区，一起讨论和分享 AI 相关的知识！</p>
                            <div class="qq-qrcode">
                                <img src="css/QQ.png" alt="QQ 交流群二维码">
                            </div>
                        </div>
                        <div class="about-section contributors-section">
                            <h3>贡献者名单</h3>
                            <p>感谢以下用户对项目提出的宝贵建议和贡献：</p>
                            <div class="contributors-list" id="contributors-list">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <div>加载贡献者中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QQ Group Modal -->
    <div id="qq-group-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📱 加入 QQ 交流群</h2>
                <button class="close-button" onclick="closeQqGroupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>欢迎加入我们的 QQ 交流群，一起讨论和分享 AI 相关的知识！</p>
                <div class="qq-group-info">
                    <div class="group-code">
                        <span class="code-label">群号：</span>
                        <span class="code-value">1071354740</span>
                    </div>
                    <div class="group-qrcode">
                        <img src="css/QQ.png" alt="QQ Group QR Code">
                    </div>
                </div>
                <div class="commercial-warning">
                    <p>⚠️ 重要提示：本项目遵循 GPLv3 开源协议！</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeQqGroupModal()">稍后再说</button>
                <a href="http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=1pOX2q6gKl41GttJcuXDoCuBVlEhWNTS&authKey=PI7D%2FlEFqlD%2B6zLjE7FCTbzsVBig%2BWMy5rCHAlQOIpsRsUZKCA%2FOYzBDzzUA%2FAaf&noverify=0&group_code=1071354740" target="_blank" class="btn btn-primary">
                    立即加入
                </a>
            </div>
        </div>
    </div>

    <!-- Role Card Detail Modal -->
        <div id="role-card-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="role-card-title">角色卡详情</h2>
                    <button class="close-button" onclick="closeRoleCardModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="role-card-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <div>加载角色卡详情中...</div>
                    </div>
                    <div id="role-card-content" style="display: none;">
                        <div class="role-card-info">
                            <div class="role-card-image">
                                <img id="role-card-image" src="" alt="角色卡图片">
                            </div>
                            <div class="role-card-details">
                                <h3 id="role-card-name">角色名称</h3>
                                <p id="role-card-intro">角色介绍</p>
                                <div class="role-card-tags" id="role-card-tags">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeRoleCardModal()">取消</button>
                    <button class="btn btn-primary" onclick="useRoleCard()">使用此角色卡</button>
                </div>
            </div>
        </div>

        <!-- Role Cards Settings Modal -->
        <div id="role-cards-settings-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>⚙️ 角色卡设置</h2>
                    <button class="close-button" onclick="closeRoleCardsSettingsModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="role-cards-api-url">
                            角色卡API URL
                            <div class="help-tooltip">
                                <div class="help-icon">?</div>
                                <div class="tooltip-text">
                                    自定义角色卡数据源的API地址，默认为Gitee上的角色卡仓库列表。
                                </div>
                            </div>
                        </label>
                        <input type="text" id="role-cards-api-url" placeholder="https://raw.githubusercontent.com/glacierbingchuan-ai/Character_Cards/refs/heads/main/list.json" style="width: 100%;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeRoleCardsSettingsModal()">取消</button>
                    <button class="btn btn-primary" onclick="saveRoleCardsSettings()">保存设置</button>
                </div>
            </div>
        </div>

    <script src="js/script.js"></script>
</body>
</html>